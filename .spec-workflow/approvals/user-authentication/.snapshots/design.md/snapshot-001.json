{
  "id": "snapshot_1769571103119_u3vk4h6t0",
  "approvalId": "approval_1769571103116_9ia6uruhf",
  "approvalTitle": "Design: User Authentication System",
  "version": 1,
  "timestamp": "2026-01-28T03:31:43.119Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# 设计文档\n\n## 概述\n\n本设计文档描述了基于Supabase的用户认证系统的完整技术实现。系统采用模块化架构，使用Vue 3 Composition API、Pinia状态管理和shadcn-vue组件库，提供可扩展、可维护的认证解决方案。\n\n该系统实现了三个核心功能：\n- 用户注册（邮箱+密码）\n- 用户登录（邮箱+密码）\n- 密码重置（邮件重置流程）\n\n## 与项目标准对齐\n\n### 技术标准\n\n本设计遵循以下技术标准和最佳实践：\n\n- **Vue 3 Composition API**: 使用 `<script setup>` 语法，提供更好的类型推断和代码组织\n- **TypeScript严格模式**: 所有组件和composables都使用TypeScript编写，确保类型安全\n- **Pinia状态管理**: 使用Pinia stores管理认证状态，支持持久化\n- **Tanstack Vue Form**: 强大的表单状态管理和验证\n- **shadcn-vue组件**: 可访问的UI组件，遵循WCAG 2.1 AA标准\n- **Tailwind CSS 4**: 实用工具优先的CSS框架，确保设计一致性\n- **Supabase Auth**: 托管的后端认证服务，提供安全的用户管理\n\n### 项目结构\n\n项目遵循清晰的分层架构：\n\n```\nsrc/\n├── composables/           # 可复用的组合式函数\n│   ├── useAuth.ts        # 认证逻辑\n│   └── useSupabase.ts    # Supabase客户端初始化\n├── stores/               # Pinia stores\n│   └── auth.ts           # 认证状态管理\n├── views/                # 页面级组件\n│   └── auth/\n│       ├── LoginView.vue\n│       ├── RegisterView.vue\n│       └── ForgotPasswordView.vue\n├── components/           # 可复用组件\n│   └── auth/\n│       ├── AuthForm.vue           # 认证表单基础组件\n│       ├── PasswordInput.vue      # 密码输入组件（带显示/隐藏）\n│       └── UpdatePasswordView.vue # 更新密码页面\n├── router/               # Vue Router配置\n│   └── index.ts\n├── lib/                  # 工具库\n│   ├── supabase.ts       # Supabase客户端\n│   └── validators.ts     # 表单验证器\n└── types/                # TypeScript类型定义\n    └── auth.ts\n```\n\n## 代码复用分析\n\n### 现有组件利用\n\n- **Button组件** (`src/shadcn/components/ui/button/Button.vue`):\n  - 用途：所有表单的提交按钮\n  - 扩展：将用于登录、注册、密码重置的提交按钮\n\n- **cn工具函数** (`src/shadcn/lib/utils.ts`):\n  - 用途：合并Tailwind CSS类名\n  - 复用：用于所有自定义组件的样式处理\n\n### 集成点\n\n- **Supabase客户端**:\n  - 环境变量配置（`VITE_SUPABASE_URL`, `VITE_SUPABASE_PUBLISHABLE_KEY`）\n  - 自动会话管理和令牌刷新\n\n- **Vue Router**:\n  - 路由守卫保护需要认证的页面\n  - 认证后自动重定向\n\n- **Pinia持久化**:\n  - 使用 `pinia-plugin-persistedstate` 持久化用户会话\n  - 页面刷新后自动恢复登录状态\n\n## 架构\n\n### 模块化设计原则\n\n- **单一文件职责**: 每个文件只处理一个特定的功能或域\n  - `useAuth.ts` - 仅包含认证逻辑\n  - `auth.ts` store - 仅管理认证状态\n  - 每个视图组件 - 仅处理一个认证流程\n\n- **组件隔离**: 创建小而专注的组件而非大型单体文件\n  - 表单组件与业务逻辑分离\n  - 密码输入组件可独立复用\n  - 基础AuthForm组件提供通用功能\n\n- **服务层分离**: 分离数据访问、业务逻辑和表示层\n  - Supabase客户端封装在 `lib/supabase.ts`\n  - 业务逻辑在 `composables/useAuth.ts`\n  - UI组件仅处理表示逻辑\n\n- **工具模块化**: 将工具分解为专注的单一目的模块\n  - 验证器独立在 `lib/validators.ts`\n  - 类型定义在 `types/auth.ts`\n\n### 架构图\n\n```mermaid\ngraph TD\n    subgraph \"视图层\"\n        Login[LoginView.vue]\n        Register[RegisterView.vue]\n        Forgot[ForgotPasswordView.vue]\n        UpdatePassword[UpdatePasswordView.vue]\n    end\n\n    subgraph \"组件层\"\n        AuthForm[AuthForm.vue]\n        PasswordInput[PasswordInput.vue]\n    end\n\n    subgraph \"状态管理层\"\n        AuthStore[auth.ts Pinia Store]\n    end\n\n    subgraph \"业务逻辑层\"\n        UseAuth[useAuth.ts Composable]\n        Validators[validators.ts]\n    end\n\n    subgraph \"数据访问层\"\n        Supabase[lib/supabase.ts]\n    end\n\n    subgraph \"外部服务\"\n        SupabaseAuth[Supabase Auth API]\n    end\n\n    Login --> AuthForm\n    Register --> AuthForm\n    Forgot --> AuthForm\n    UpdatePassword --> PasswordInput\n\n    AuthForm --> UseAuth\n    PasswordInput --> Validators\n\n    UseAuth --> AuthStore\n    AuthStore --> Supabase\n    Supabase --> SupabaseAuth\n\n    AuthStore -.持久化.-> LocalStorage[Local Storage]\n```\n\n### 数据流\n\n```mermaid\nsequenceDiagram\n    participant U as 用户\n    participant V as 视图组件\n    participant C as useAuth Composable\n    participant S as auth Store\n    participant SP as Supabase客户端\n\n    U->>V: 输入凭证\n    V->>C: 调用认证方法\n    C->>SP: 发起认证请求\n    SP-->>C: 返回结果\n    C->>S: 更新认证状态\n    S->>V: 状态变化通知\n    V->>U: 显示成功/错误消息\n    S-->>LocalStorage: 持久化会话\n```\n\n## 组件和接口\n\n### Composable: useAuth\n\n**目的**: 封装所有Supabase认证逻辑，提供类型安全的认证方法\n\n**接口**:\n```typescript\ninterface UseAuthReturn {\n  // 状态\n  user: Ref<User | null>\n  session: Ref<Session | null>\n  loading: Ref<boolean>\n  error: Ref<string | null>\n\n  // 方法\n  signUp: (email: string, password: string) => Promise<void>\n  signIn: (email: string, password: string) => Promise<void>\n  signOut: () => Promise<void>\n  resetPassword: (email: string) => Promise<void>\n  updatePassword: (newPassword: string) => Promise<void>\n\n  // 会话管理\n  initialize: () => Promise<void>\n}\n```\n\n**依赖**:\n- Supabase客户端 (`lib/supabase.ts`)\n- Pinia auth store\n\n**复用**:\n- Supabase Auth SDK方法\n- 现有的错误处理工具\n\n### Pinia Store: auth\n\n**目的**: 管理全局认证状态，提供持久化\n\n**接口**:\n```typescript\ninterface AuthState {\n  user: User | null\n  session: Session | null\n  isAuthenticated: boolean\n  loading: boolean\n}\n\ninterface AuthActions {\n  setUser: (user: User | null) => void\n  setSession: (session: Session | null) => void\n  clearAuth: () => void\n  setLoading: (loading: boolean) => void\n}\n```\n\n**依赖**:\n- Supabase类型定义\n- pinia-plugin-persistedstate\n\n**持久化配置**:\n- 存储到localStorage\n- 持久化 `user` 和 `session` 字段\n\n### 组件: AuthForm\n\n**目的**: 提供认证表单的通用UI结构和功能\n\n**Props**:\n```typescript\ninterface AuthFormProps {\n  title: string           // 表单标题\n  description?: string    // 描述文本\n  submitLabel: string     // 提交按钮文本\n  onSubmit: () => void    // 提交处理函数\n  loading: boolean        // 加载状态\n  error?: string | null   // 错误消息\n}\n```\n\n**Slots**:\n- `default`: 表单字段内容\n- `footer`: 表单底部内容（如链接）\n\n**依赖**:\n- Button组件\n- 表单验证组件\n\n**复用**:\n- 继Button组件\n- 继cn工具函数用于样式合并\n\n### 组件: PasswordInput\n\n**目的**: 提供带显示/隐藏切换的密码输入框\n\n**Props**:\n```typescript\ninterface PasswordInputProps {\n  modelValue: string\n  label?: string\n  placeholder?: string\n  error?: string\n  required?: boolean\n}\n```\n\n**功能**:\n- 密码显示/隐藏切换\n- 密码强度指示器\n- 内联错误显示\n\n**依赖**:\n- lucide-vue-next图标（Eye/EyeOff）\n\n### 视图: LoginView\n\n**目的**: 用户登录页面\n\n**功能**:\n- 邮箱和密码输入\n- 表单验证\n- 记住我选项\n- \"忘记密码\"链接\n- 跳转到注册页面\n\n**表单字段**:\n- email (必填，邮箱格式)\n- password (必填，最小8字符)\n- rememberMe (可选)\n\n**路由**:\n- 路径: `/auth/login`\n- 认证成功后重定向到首页或之前的页面\n\n### 视图: RegisterView\n\n**目的**: 用户注册页面\n\n**功能**:\n- 邮箱、密码、确认密码输入\n- 表单验证（密码匹配、强度检查）\n- 服务条款和隐私政策复选框\n- 跳转到登录页面\n\n**表单字段**:\n- email (必填，邮箱格式)\n- password (必填，最小8字符)\n- confirmPassword (必填，必须匹配password)\n- agreeToTerms (必选)\n\n**路由**:\n- 路径: `/auth/register`\n- 注册成功后重定向到登录页面\n\n### 视图: ForgotPasswordView\n\n**目的**: 密码重置请求页面\n\n**功能**:\n- 邮箱输入\n- 表单验证\n- 成功消息显示\n- 返回登录页面\n\n**表单字段**:\n- email (必填，邮箱格式)\n\n**路由**:\n- 路径: `/auth/forgot-password`\n- 提交成功后显示确认消息\n\n### 视图: UpdatePasswordView\n\n**目的**: 更新密码页面（从邮件链接重定向过来）\n\n**功能**:\n- 新密码输入\n- 确认密码输入\n- 表单验证（密码匹配、强度检查）\n- 成功后重定向到登录页面\n\n**表单字段**:\n- password (必填，最小8字符)\n- confirmPassword (必填，必须匹配password)\n\n**路由**:\n- 路径: `/auth/update-password`\n- 需要认证才能访问（路由守卫）\n\n## 数据模型\n\n### User (Supabase)\n\n```typescript\ninterface User {\n  id: string\n  email: string\n  email_confirmed_at?: string\n  created_at: string\n  updated_at?: string\n  user_metadata: Record<string, any>\n}\n```\n\n### Session (Supabase)\n\n```typescript\ninterface Session {\n  access_token: string\n  refresh_token: string\n  expires_in: number\n  token_type: string\n  user: User\n}\n```\n\n### 表单数据模型\n\n```typescript\n// 登录表单\ninterface LoginFormData {\n  email: string\n  password: string\n  rememberMe?: boolean\n}\n\n// 注册表单\ninterface RegisterFormData {\n  email: string\n  password: string\n  confirmPassword: string\n  agreeToTerms: boolean\n}\n\n// 密码重置表单\ninterface ResetPasswordFormData {\n  email: string\n}\n\n// 更新密码表单\ninterface UpdatePasswordFormData {\n  password: string\n  confirmPassword: string\n}\n```\n\n### 验证规则\n\n```typescript\n// 邮箱验证\nconst emailPattern = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/\n\n// 密码验证\nconst passwordMinLength = 8\nconst passwordPattern = /^(?=.*[A-Za-z])(?=.*\\d)[A-Za-z\\d@$!%*#?&]/\n\n// 或者更简单的规则：\n// 至少8个字符\nconst passwordMinLength = 8\n```\n\n## 错误处理\n\n### 错误场景\n\n1. **网络错误**\n   - **处理**: 捕获网络异常，显示用户友好的错误消息\n   - **用户影响**: 看到提示\"网络连接失败，请检查网络后重试\"\n\n2. **无效凭证**\n   - **处理**: Supabase返回特定错误码，显示\"邮箱或密码错误\"\n   - **用户影响**: 看到内联错误提示在表单下方\n\n3. **邮箱已存在**\n   - **处理**: 捕获Supabase的\"用户已存在\"错误\n   - **用户影响**: 看到提示\"该邮箱已被注册，请直接登录\"\n\n4. **密码过弱**\n   - **处理**: 客户端验证 + 服务端验证\n   - **用户影响**: 实时看到密码强度提示\n\n5. **密码不匹配**\n   - **处理**: 客户端验证\n   - **用户影响**: 实时看到\"密码不匹配\"提示\n\n6. **未确认邮箱**\n   - **处理**: 检查Supabase返回的错误类型\n   - **用户影响**: 看到\"请先确认您的邮箱地址\"\n\n7. **会话过期**\n   - **处理**: Supabase自动刷新令牌，刷新失败则登出\n   - **用户影响**: 自动重定向到登录页面\n\n### 错误消息映射\n\n```typescript\nconst errorMessages: Record<string, string> = {\n  'Invalid login credentials': '邮箱或密码错误',\n  'Email not confirmed': '请先确认您的邮箱地址',\n  'User already registered': '该邮箱已被注册',\n  'Password should be at least 8 characters': '密码至少需要8个字符',\n  'Network request failed': '网络连接失败，请检查网络后重试',\n  'default': '操作失败，请稍后重试'\n}\n```\n\n### 错误处理策略\n\n- **即时反馈**: 表单验证错误立即显示，不等待提交\n- **内联错误**: 错误消息显示在相关字段下方\n- **Toast通知**: 操作成功/失败显示toast消息\n- **错误日志**: 使用Supabase日志记录，方便调试\n\n## 测试策略\n\n### 单元测试\n\n**测试框架**: Vitest\n\n**关键测试组件**:\n\n1. **验证器测试** (`lib/validators.ts`)\n   - 测试邮箱验证规则\n   - 测试密码强度验证\n   - 测试密码匹配验证\n\n2. **useAuth Composable测试**\n   - Mock Supabase客户端\n   - 测试signUp方法\n   - 测试signIn方法\n   - 测试signOut方法\n   - 测试resetPassword方法\n\n3. **auth Store测试**\n   - 测试状态更新\n   - 测试持久化功能\n   - 测试actions\n\n**示例测试**:\n```typescript\ndescribe('useAuth', () => {\n  it('should sign in user with valid credentials', async () => {\n    const { signIn, user } = useAuth()\n    await signIn('test@example.com', 'password123')\n    expect(user.value).toBeDefined()\n    expect(user.value?.email).toBe('test@example.com')\n  })\n\n  it('should handle sign in error', async () => {\n    const { signIn, error } = useAuth()\n    await signIn('invalid@example.com', 'wrong')\n    expect(error.value).toBeTruthy()\n  })\n})\n```\n\n### 集成测试\n\n**测试场景**:\n\n1. **注册流程**\n   - 填写注册表单 → 提交 → 验证Supabase调用 → 检查重定向\n\n2. **登录流程**\n   - 填写登录表单 → 提交 → 验证Supabase调用 → 检查会话存储 → 检查重定向\n\n3. **密码重置流程**\n   - 请求重置邮件 → 验证Supabase调用 → 点击邮件链接 → 更新密码 → 验证新密码\n\n4. **路由守卫**\n   - 访问受保护页面未登录 → 检查重定向到登录页\n   - 登录后访问认证页面 → 检查重定向到首页\n\n**测试工具**:\n- Vitest + Vue Test Utils\n- MSW (Mock Service Worker) 模拟Supabase API\n\n### 端到端测试\n\n**测试框架**: Playwright或Cypress\n\n**用户场景**:\n\n1. **新用户注册并登录**\n   ```\n   1. 访问注册页面\n   2. 填写邮箱、密码、确认密码\n   3. 勾选同意条款\n   4. 提交表单\n   5. 验证重定向到登录页\n   6. 使用相同凭证登录\n   7. 验证登录成功并重定向到首页\n   ```\n\n2. **忘记密码并重置**\n   ```\n   1. 访问登录页面\n   2. 点击\"忘记密码\"链接\n   3. 输入注册邮箱\n   4. 提交表单\n   5. 验证显示成功消息\n   6. (使用测试邮箱工具) 打开密码重置邮件\n   7. 点击重置链接\n   8. 输入新密码\n   9. 提交表单\n   10. 验证重定向到登录页\n   11. 使用新密码登录\n   12. 验证登录成功\n   ```\n\n3. **会话持久化**\n   ```\n   1. 登录\n   2. 刷新页面\n   3. 验证仍然保持登录状态\n   4. 关闭浏览器\n   5. 重新打开应用\n   6. 验证仍然保持登录状态（如果选择了\"记住我\"）\n   ```\n\n4. **表单验证**\n   ```\n   1. 尝试提交空表单\n   2. 验证显示必填字段错误\n   3. 输入无效邮箱格式\n   4. 验证显示邮箱格式错误\n   5. 输入短密码（< 8字符）\n   6. 验证显示密码强度错误\n   7. 注册时密码不匹配\n   8. 验证显示密码不匹配错误\n   ```\n\n## 安全考虑\n\n1. **环境变量**: Supabase密钥通过环境变量管理，不提交到git\n2. **HTTPS**: 生产环境强制使用HTTPS\n3. **XSS防护**: Vue自动转义输出，避免v-html使用用户输入\n4. **CSRF保护**: Supabase自动处理CSRF令牌\n5. **密码强度**: 最小8字符，客户端和服务端双重验证\n6. **会话管理**: 使用Supabase的自动令牌刷新\n7. **错误消息**: 不泄露敏感信息（如\"用户存在\"vs\"密码错误\"）\n\n## 性能优化\n\n1. **懒加载**: 认证页面使用路由级代码分割\n2. **组件缓存**: 使用Vue的`<KeepAlive>`缓存表单状态\n3. **防抖**: 表单输入使用防抖减少验证频率\n4. **预加载**: 关键按钮和表单预加载\n5. **Supabase连接**: 复用Supabase客户端实例\n\n## 可访问性\n\n1. **键盘导航**: 所有表单元素支持键盘导航\n2. **ARIA标签**: 使用语义化HTML和ARIA属性\n3. **焦点管理**: 表单提交后焦点管理\n4. **屏幕阅读器**: 错误消息通过`aria-live`宣布\n5. **颜色对比**: 符合WCAG 2.1 AA标准\n6. **触摸目标**: 最小44x44px的触摸目标尺寸\n",
  "fileStats": {
    "size": 16041,
    "lines": 632,
    "lastModified": "2026-01-28T03:31:39.172Z"
  },
  "comments": []
}