{
  "id": "snapshot_1769609095837_p37pz7rzn",
  "approvalId": "approval_1769609095831_rxbm6mgix",
  "approvalTitle": "认证功能端到端测试 - Design 阶段",
  "version": 1,
  "timestamp": "2026-01-28T14:04:55.837Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\n本设计文档定义了使用 Chrome MCP 进行用户认证功能端到端（E2E）测试的技术实现方案。通过 Chrome MCP 的浏览器自动化能力，在真实的 Chrome 浏览器环境中模拟用户操作，验证登录、注册、密码重置等核心功能的完整流程，确保系统的稳定性和用户体验质量。\n\n### 技术栈\n- **Chrome MCP**: 浏览器自动化工具，提供页面导航、元素查找、交互操作等能力\n- **TypeScript**: 类型安全的测试脚本编写\n- **Node.js**: 测试运行环境\n- **测试框架**: 自定义测试运行器，支持测试组织、执行和报告\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n本设计遵循以下技术标准：\n\n1. **TypeScript 优先**: 所有测试代码使用 TypeScript 编写，确保类型安全\n2. **模块化设计**: 测试代码按功能模块组织，每个模块独立可测\n3. **错误处理**: 完善的错误捕获和处理机制，确保测试失败时提供清晰的诊断信息\n4. **代码复用**: 提取通用操作为辅助函数，避免代码重复\n\n### Project Structure (structure.md)\n\n测试文件将按照以下结构组织：\n\n```\ntests/\n├── e2e/\n│   ├── auth/\n│   │   ├── helpers/          # 辅助函数和页面对象\n│   │   │   ├── browser.ts    # Chrome MCP 封装\n│   │   │   ├── selectors.ts  # 元素选择器\n│   │   │   └── test-data.ts  # 测试数据\n│   │   ├── login.spec.ts     # 登录功能测试\n│   │   ├── register.spec.ts  # 注册功能测试\n│   │   ├── forgot-password.spec.ts  # 密码重置测试\n│   │   └── form-validation.spec.ts  # 表单验证测试\n│   ├── runner.ts             # 测试运行器\n│   └── reporter.ts           # 测试报告生成器\n└── fixtures/                 # 测试夹具和配置\n    └── auth-config.ts        # 认证测试配置\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n1. **认证视图组件** (`src/features/auth/views/`)\n   - **LoginView.vue**: 登录页面组件，包含邮箱、密码输入框和登录按钮\n   - **RegisterView.vue**: 注册页面组件，包含邮箱、密码、确认密码和服务条款\n   - **ForgotPasswordView.vue**: 忘记密码页面，包含邮箱输入和成功状态\n   - **用途**: E2E 测试将直接与这些渲染的组件交互\n\n2. **验证器工具** (`src/features/auth/utils/validators.ts`)\n   - **email()**: 邮箱格式验证\n   - **密码长度验证**: 至少 8 个字符\n   - **用途**: 测试中将使用相同的验证规则验证前端表单行为\n\n3. **路由配置** (`src/router`)\n   - **/auth/login**: 登录页面路由\n   - **/auth/register**: 注册页面路由\n   - **/auth/forgot-password**: 忘记密码页面路由\n   - **用途**: 测试导航和页面跳转\n\n4. **Supabase 配置** (`.env`)\n   - **测试环境 Supabase URL**: 用于测试环境的认证服务\n   - **测试环境 Supabase Anon Key**: 测试用的匿名密钥\n   - **用途**: 测试将使用测试环境的 Supabase 实例，避免影响生产数据\n\n### Integration Points\n\n1. **前端应用**: `http://localhost:5173` (开发服务器)\n   - E2E 测试将启动或连接到正在运行的开发服务器\n   - 通过浏览器访问前端页面进行测试\n\n2. **Supabase Auth**: 测试环境的认证后端\n   - 创建测试账号进行注册测试\n   - 验证登录功能\n   - 测试密码重置流程\n   - 测试完成后清理测试数据\n\n## Architecture\n\n### 整体架构\n\nE2E 测试采用分层架构设计：\n\n1. **测试运行器层** (Test Runner)\n   - 负责测试的发现、执行和结果收集\n   - 提供测试生命周期钩子（beforeAll, afterAll, beforeEach, afterEach）\n   - 生成测试报告\n\n2. **浏览器控制层** (Browser Control)\n   - 封装 Chrome MCP API\n   - 提供页面导航、元素查找、交互操作的抽象接口\n   - 管理浏览器实例和会话\n\n3. **页面对象层** (Page Objects)\n   - 将每个页面封装为对象，提供语义化的操作方法\n   - 隐藏实现细节，提高测试可维护性\n   - LoginPage, RegisterPage, ForgotPasswordPage\n\n4. **测试用例层** (Test Cases)\n   - 具体的测试场景\n   - 使用页面对象和辅助函数编写测试逻辑\n   - 验证业务需求和验收标准\n\n### Modular Design Principles\n\n- **Single File Responsibility**: 每个测试文件专注于一个功能模块（登录、注册、密码重置）\n- **Component Isolation**: 每个页面对象独立封装，不依赖其他页面\n- **Service Layer Separation**: 测试逻辑与浏览器控制分离，便于替换实现\n- **Utility Modularity**: 辅助函数按功能拆分（导航、表单填写、断言）\n\n```mermaid\ngraph TD\n    A[Test Runner] --> B[Browser Control Layer]\n    B --> C[Chrome MCP]\n    C --> D[Chrome Browser]\n    A --> E[Test Suites]\n    E --> F[Login Tests]\n    E --> G[Register Tests]\n    E --> H[Forgot Password Tests]\n    E --> I[Form Validation Tests]\n    F --> J[Page Objects]\n    G --> J\n    H --> J\n    I --> J\n    J --> K[Helpers & Selectors]\n    J --> B\n```\n\n## Components and Interfaces\n\n### 1. Browser Helper (`browser.ts`)\n\n**Purpose**: 封装 Chrome MCP API，提供简化的浏览器操作接口\n\n**Interfaces**:\n```typescript\ninterface BrowserHelper {\n  // 页面导航\n  navigateTo(url: string): Promise<void>\n  waitForPageLoad(): Promise<void>\n\n  // 元素查找\n  findElement(selector: string): Promise<ElementHandle>\n  findElements(selector: string): Promise<ElementHandle[]>\n\n  // 交互操作\n  click(selector: string): Promise<void>\n  fillInput(selector: string, value: string): Promise<void>\n  checkCheckbox(selector: string): Promise<void>\n\n  // 等待和断言\n  waitForElement(selector: string, timeout?: number): Promise<ElementHandle>\n  waitForText(selector: string, text: string): Promise<void>\n  isVisible(selector: string): Promise<boolean>\n  getText(selector: string): Promise<string>\n  getAttribute(selector: string, attribute: string): Promise<string>\n\n  // 浏览器控制\n  screenshot(path: string): Promise<void>\n  close(): Promise<void>\n}\n```\n\n**Dependencies**:\n- Chrome MCP 工具集\n\n**Reuses**:\n- 无（底层封装）\n\n### 2. Selectors (`selectors.ts`)\n\n**Purpose**: 集中管理所有测试选择器，便于维护\n\n**Interfaces**:\n```typescript\ninterface AuthSelectors {\n  // 通用选择器\n  emailInput: string\n  passwordInput: string\n  submitButton: string\n  errorMessage: string\n  loadingIndicator: string\n\n  // 注册页面\n  confirmPasswordInput: string\n  agreeTermsCheckbox: string\n\n  // 忘记密码页面\n  resendButton: string\n  returnToLoginButton: string\n  successMessage: string\n}\n\nconst authSelectors: AuthSelectors = {\n  emailInput: '#email',\n  passwordInput: '#password',\n  submitButton: 'button[type=\"submit\"]',\n  errorMessage: '[data-testid=\"auth-error\"]',\n  loadingIndicator: '[data-testid=\"loading\"]',\n  confirmPasswordInput: '#confirmPassword',\n  agreeTermsCheckbox: '#agree-terms',\n  resendButton: 'button:has-text(\"重新发送\")',\n  returnToLoginButton: 'button:has-text(\"返回登录\")',\n  successMessage: '[data-testid=\"success-message\"]'\n}\n```\n\n**Dependencies**:\n- 无\n\n**Reuses**:\n- 与前端组件的 data-testid 属性对应\n\n### 3. Page Objects\n\n**3.1 LoginPage**\n\n**Purpose**: 封装登录页面的所有操作和状态查询\n\n**Interfaces**:\n```typescript\nclass LoginPage {\n  // 导航到登录页\n  visit(): Promise<void>\n\n  // 填写登录表单\n  fillEmail(email: string): Promise<void>\n  fillPassword(password: string): Promise<void>\n\n  // 提交表单\n  submit(): Promise<void>\n\n  // 状态查询\n  getErrorMessage(): Promise<string>\n  isLoading(): Promise<boolean>\n  isRedirected(): Promise<boolean>\n\n  // 完整操作流程\n  login(email: string, password: string): Promise<void>\n}\n```\n\n**Dependencies**:\n- BrowserHelper\n- authSelectors\n\n**Reuses**:\n- 使用统一的浏览器控制接口\n- 使用集中的选择器定义\n\n**3.2 RegisterPage**\n\n**Purpose**: 封装注册页面的所有操作和状态查询\n\n**Interfaces**:\n```typescript\nclass RegisterPage {\n  visit(): Promise<void>\n\n  fillEmail(email: string): Promise<void>\n  fillPassword(password: string): Promise<void>\n  fillConfirmPassword(password: string): Promise<void>\n  agreeTerms(agree: boolean): Promise<void>\n\n  submit(): Promise<void>\n\n  getErrorMessage(): Promise<string>\n  getFieldError(fieldName: 'email' | 'password' | 'confirmPassword'): Promise<string>\n  isLoading(): Promise<boolean>\n  isRedirectedToLogin(): Promise<boolean>\n\n  register(email: string, password: string): Promise<void>\n}\n```\n\n**Dependencies**:\n- BrowserHelper\n- authSelectors\n\n**Reuses**:\n- BrowserHelper 基础接口\n\n**3.3 ForgotPasswordPage**\n\n**Purpose**: 封装忘记密码页面的所有操作和状态查询\n\n**Interfaces**:\n```typescript\nclass ForgotPasswordPage {\n  visit(): Promise<void>\n\n  fillEmail(email: string): Promise<void>\n  submit(): Promise<void>\n\n  getErrorMessage(): Promise<string>\n  getSuccessMessage(): Promise<string>\n  isLoading(): Promise<boolean>\n  isSuccessState(): Promise<boolean>\n\n  returnToLogin(): Promise<void>\n  resend(): Promise<void>\n}\n```\n\n**Dependencies**:\n- BrowserHelper\n- authSelectors\n\n**Reuses**:\n- BrowserHelper 基础接口\n\n### 4. Test Data Manager (`test-data.ts`)\n\n**Purpose**: 管理测试数据，生成唯一的测试用户凭据\n\n**Interfaces**:\n```typescript\ninterface TestData {\n  validEmail: string\n  invalidEmail: string\n  validPassword: string\n  shortPassword: string\n  weakPassword: string\n}\n\nclass TestDataManager {\n  // 生成唯一的测试邮箱\n  generateUniqueEmail(): string\n\n  // 预定义测试数据\n  get testData(): TestData\n\n  // 清理测试数据（删除测试账号）\n  async cleanupTestUser(email: string): Promise<void>\n}\n```\n\n**Dependencies**:\n- Supabase 客户端（用于清理测试数据）\n\n**Reuses**:\n- Supabase admin API 用于测试数据清理\n\n### 5. Test Runner (`runner.ts`)\n\n**Purpose**: 测试运行器，负责测试的发现、执行和报告\n\n**Interfaces**:\n```typescript\ninterface TestSuite {\n  name: string\n  tests: TestCase[]\n  beforeAll?: () => Promise<void>\n  afterAll?: () => Promise<void>\n  beforeEach?: () => Promise<void>\n  afterEach?: () => Promise<void>\n}\n\ninterface TestCase {\n  name: string\n  fn: () => Promise<void>\n  timeout?: number\n}\n\nclass TestRunner {\n  // 注册测试套件\n  registerSuite(suite: TestSuite): void\n\n  // 运行所有测试\n  run(): Promise<TestResults>\n\n  // 运行特定测试套件\n  runSuite(suiteName: string): Promise<TestResults>\n}\n\ninterface TestResults {\n  total: number\n  passed: number\n  failed: number\n  duration: number\n  failures: TestFailure[]\n}\n\ninterface TestFailure {\n  testName: string\n  error: Error\n  screenshot?: string\n}\n```\n\n**Dependencies**:\n- BrowserHelper（用于全局浏览器管理）\n- Reporter（用于生成报告）\n\n**Reuses**:\n- 无（核心运行器）\n\n### 6. Reporter (`reporter.ts`)\n\n**Purpose**: 生成测试报告，提供清晰的测试结果展示\n\n**Interfaces**:\n```typescript\nclass TestReporter {\n  // 报告测试开始\n  onTestStart(testName: string): void\n\n  // 报告测试通过\n  onTestPass(testName: string, duration: number): void\n\n  // 报告测试失败\n  onTestFail(testName: string, error: Error, screenshot?: string): void\n\n  // 生成最终报告\n  generateReport(results: TestResults): Promise<void>\n}\n```\n\n**Dependencies**:\n- 文件系统（用于保存报告和截图）\n\n**Reuses**:\n- 无\n\n## Data Models\n\n### Test Result Model\n\n```typescript\ninterface TestResult {\n  id: string\n  suiteName: string\n  testName: string\n  status: 'passed' | 'failed' | 'skipped'\n  duration: number\n  error?: Error\n  screenshot?: string\n  timestamp: Date\n}\n\ninterface TestSuiteResult {\n  suiteName: string\n  tests: TestResult[]\n  summary: {\n    total: number\n    passed: number\n    failed: number\n    duration: number\n  }\n}\n```\n\n### Test User Model\n\n```typescript\ninterface TestUser {\n  email: string\n  password: string\n  createdAt: Date\n  shouldCleanup: boolean\n}\n```\n\n### Test Configuration Model\n\n```typescript\ninterface TestConfig {\n  baseUrl: string\n  supabaseUrl: string\n  supabaseAnonKey: string\n  supabaseServiceKey: string\n  timeout: number\n  screenshotOnFailure: boolean\n  cleanupTestData: boolean\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **页面加载超时**\n   - **场景**: 导航到页面后在指定时间内页面未完成加载\n   - **处理**: 等待最长 10 秒，超时后记录错误并截图，标记测试失败\n   - **用户影响**: 测试失败，错误日志包含超时信息和截图\n\n2. **元素未找到**\n   - **场景**: 查找的 DOM 元素在页面中不存在\n   - **处理**: 等待元素出现（最长 5 秒），超时后记录错误和当前页面 URL\n   - **用户影响**: 测试失败，错误信息包含缺失元素的选择器\n\n3. **交互失败**\n   - **场景**: 点击、填写表单等操作失败（元素被遮挡、不可见等）\n   - **处理**: 捕获异常，记录错误和截图，尝试滚动到元素可见区域后重试一次\n   - **用户影响**: 测试失败，错误信息包含原始错误和重试状态\n\n4. **断言失败**\n   - **场景**: 实际结果与预期结果不符\n   - **处理**: 记录详细的断言失败信息（期望值 vs 实际值），截图\n   - **用户影响**: 测试失败，错误信息清晰显示差异\n\n5. **网络错误**\n   - **场景**: API 请求失败（网络超时、服务器错误等）\n   - **处理**: 记录网络错误详情，检查页面是否显示正确的错误提示\n   - **用户影响**: 测试可能失败（取决于预期的错误处理行为）\n\n6. **测试数据冲突**\n   - **场景**: 尝试注册已存在的邮箱\n   - **处理**: 每次测试生成唯一的邮箱地址（使用时间戳和随机数）\n   - **用户影响**: 不应发生（通过唯一邮箱生成避免）\n\n### 错误报告格式\n\n```typescript\ninterface TestError {\n  message: string\n  selector?: string\n  url?: string\n  screenshot?: string\n  stackTrace?: string\n  timestamp: Date\n}\n```\n\n## Testing Strategy\n\n### E2E 测试组织\n\n测试按功能模块组织成独立的测试套件：\n\n1. **Login Test Suite** (`login.spec.ts`)\n   - 测试登录页面的所有验收标准\n   - 包含 5-7 个测试用例\n\n2. **Register Test Suite** (`register.spec.ts`)\n   - 测试注册流程的所有验收标准\n   - 包含 6-8 个测试用例\n\n3. **Forgot Password Test Suite** (`forgot-password.spec.ts`)\n   - 测试密码重置流程\n   - 包含 4-5 个测试用例\n\n4. **Form Validation Test Suite** (`form-validation.spec.ts`)\n   - 测试所有表单验证规则\n   - 包含 5-6 个测试用例\n\n### 测试执行流程\n\n1. **前置条件**\n   - 启动开发服务器（`pnpm dev`）\n   - 确保 Supabase 测试环境可用\n   - 初始化 Chrome MCP 浏览器实例\n\n2. **测试执行**\n   - 按测试套件顺序执行\n   - 每个测试独立运行，不依赖其他测试的状态\n   - 测试失败时截图并继续执行下一个测试\n\n3. **后置清理**\n   - 清理测试数据（删除测试账号）\n   - 关闭浏览器实例\n   - 生成测试报告\n\n### 测试覆盖率\n\n- **功能覆盖**: 所有需求文档中定义的验收标准\n- **场景覆盖**: 正常流程、错误流程、边界情况\n- **页面覆盖**: 登录页、注册页、忘记密码页\n\n### 测试隔离\n\n- 每个测试用例独立运行\n- 使用唯一的测试数据（邮箱、用户名）\n- 测试之间不共享状态\n- 失败的测试不影响其他测试的执行\n\n### 性能要求\n\n- 单个测试用例执行时间 < 30 秒\n- 完整测试套件执行时间 < 5 分钟\n- 页面加载等待时间最长 10 秒\n- 元素查找等待时间最长 5 秒\n\n### 重试机制\n\n对于偶发性失败（如网络延迟、页面加载慢），支持测试重试：\n- 失败后自动重试 1 次\n- 重试前等待 2 秒\n- 两次都失败才标记为测试失败\n\n## Security Considerations\n\n### 测试环境隔离\n\n- 使用独立的 Supabase 测试项目\n- 测试环境 Supabase URL 和密钥存储在 `.env.test` 文件\n- 测试代码绝不使用生产环境凭据\n\n### 测试数据管理\n\n- 测试账号密码符合安全要求（至少 8 个字符）\n- 测试完成后清理测试数据\n- 不使用真实用户数据进行测试\n\n### 敏感信息保护\n\n- `.env.test` 文件不提交到版本控制\n- 测试报告中不包含敏感信息（密码、令牌等）\n- 截图中避免包含敏感数据（必要时打码）\n\n## Implementation Notes\n\n### Chrome MCP 集成\n\n由于 Chrome MCP 可能提供特定的工具集，实际的浏览器控制实现将根据可用的 MCP 工具进行调整。设计中的 `BrowserHelper` 接口将作为抽象层，便于适配 Chrome MCP 的具体 API。\n\n### 测试运行器选择\n\n根据项目需求和 Chrome MCP 的特性，可能采用以下方案之一：\n1. **自定义测试运行器**: 完全自主实现，轻量级\n2. **集成现有框架**: 如 Playwright、Puppeteer（如果 Chrome MCP 支持与之互操作）\n3. **混合方案**: 使用现有框架的断言库，自定义 Chrome MCP 集成\n\n### 预期的 Chrome MCP 工具\n\n基于 MCP 标准和 Chrome 自动化需求，预期 Chrome MCP 将提供以下工具：\n- 页面导航和加载\n- 元素查找和选择\n- 点击、输入、滚动等交互\n- 元素状态查询（可见性、文本内容、属性）\n- 截图和 PDF 生成\n- JavaScript 执行\n- 网络请求拦截和 mock（可选）\n\n实际的工具集将在实现阶段根据 Chrome MCP 的可用工具进行调整。\n",
  "fileStats": {
    "size": 17584,
    "lines": 642,
    "lastModified": "2026-01-28T14:04:50.067Z"
  },
  "comments": []
}